#### **1. Определения**
- **Мьютекс (mutex)**  
  Примитив синхронизации, гарантирующий, что только **один поток** может выполнять критическую секцию кода.  
  - Пример: Защита общего счётчика от race condition.  

- **Семафор (semaphore)**  
  Счётчик, ограничивающий **количество потоков**, которые могут одновременно работать с ресурсом.  
  - Пример: Ограничение пула подключений к базе данных.  

#### **2. Различия между мьютексом и семафором**  
| **Критерий**                     | **Мьютекс**                                               | **Семафор**                                                 |
| -------------------------------- | --------------------------------------------------------- | ----------------------------------------------------------- |
| **Доступ**                       | Эксклюзивный (1 поток)                                    | До N потоков                                                |
| **Владелец**                     | Захватывается и освобождается одним потоком               | Управляется разными потоками (через `acquire`/`release`)    |
| **Инициализация**                | Всегда в состоянии 0 (заблокирован) или 1 (разблокирован) | Задаётся начальное значение (например, 3)                   |
| **Межпроцессное взаимодействие** | Нет                                                       | Да (если размещён в разделяемой памяти)                     |
| **Deadlock**                     | Возможен (если забыть `unlock()`)                         | Менее вероятен (но возможен при неправильном использовании) |

#### **3. Виды мьютексов в C++**  

1. **`std::mutex`**  
   - Базовый мьютекс. Не поддерживает рекурсивный захват.  
   - **Пример**:  
     ```cpp
     std::mutex mtx;
     mtx.lock();
     // Критическая секция...
     mtx.unlock();
     ```  

2. **`std::recursive_mutex`**  
   - Позволяет **рекурсивный захват** (один поток может вызвать `lock()` несколько раз).  
   - **Пример**:  
     ```cpp
     std::recursive_mutex rmtx;
     rmtx.lock();
     rmtx.lock();  // OK (счётчик увеличивается)
     rmtx.unlock();
     rmtx.unlock();
     ```  

3. **`std::timed_mutex`**  
   - Мьютекс с **таймаутом** (можно ждать захват определённое время).  
   - **Пример**:  
     ```cpp
     std::timed_mutex tmtx;
     if (tmtx.try_lock_for(std::chrono::seconds(1))) {
         // Захвачен за 1 секунду...
         tmtx.unlock();
     }
     ```  

4. **`std::recursive_timed_mutex`**  
   - Комбинация `recursive_mutex` и `timed_mutex`.  
   - **Пример**:  
     ```cpp
     std::recursive_timed_mutex rtmtx;
     if (rtmtx.try_lock_for(std::chrono::seconds(1))) {
         rtmtx.lock();  // Рекурсивный захват
         rtmtx.unlock();
         rtmtx.unlock();
     }
     ```  

5. **`std::shared_mutex` (C++17)**  
   - Поддерживает **два режима**:  
     - `lock()` — эксклюзивная запись (только один поток).  
     - `lock_shared()` — совместное чтение (много потоков).  
   - **Пример**:  
     ```cpp
     std::shared_mutex shmtx;
     // Чтение (много потоков)
     {
         std::shared_lock lock(shmtx);
         std::cout << data;
     }
     // Запись (один поток)
     {
         std::unique_lock lock(shmtx);
         data = 42;
     }
     ```  

#### **4. Когда что использовать?**  
- **Мьютекс**:  
  - Защита общих данных (например, изменение переменной).  
  - Когда нужен **эксклюзивный доступ**.  
- **Семафор**:  
  - Ограничение числа потоков (например, пул соединений).  
  - Реализация паттерна **Producer-Consumer**.  
- **Рекурсивный мьютекс**:  
  - Рекурсивные функции, которые могут вызывать себя.  
- **Shared мьютекс**:  
  - Частое чтение + редкая запись (например, кэш).  

#### **5. Примеры кода**  
**Мьютекс с `std::lock_guard`**  
```cpp
std::mutex mtx;
int counter = 0;

void safe_increment() {
    std::lock_guard<std::mutex> lock(mtx);  // Автоматический unlock()
    ++counter;
}
```  

**Семафор (C++20)**  
```cpp
#include <semaphore>
std::counting_semaphore<10> sem(3);  // Макс. 3 потока

void worker() {
    sem.acquire();  // Захватываем слот
    // Работаем с ресурсом...
    sem.release();  // Освобождаем
}
```  

**Идеальный ответ:**  
*"Мьютекс гарантирует эксклюзивный доступ для одного потока, а семафор ограничивает количество потоков, работающих с ресурсом. В C++ есть несколько видов мьютексов: `std::mutex` (базовый), `recursive_mutex` (рекурсивный), `timed_mutex` (с таймаутом) и `shared_mutex` (для чтения/записи). Различия: мьютекс владеется одним потоком, семафор — нет; мьютекс инициализируется как 0/1, семафор — с заданным значением. Best practice: для защиты данных используйте `lock_guard`, для ограничения потоков — семафоры."*